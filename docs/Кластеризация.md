## Функция `preparing_data_for_clustering`

### 1. Подготовка точек и полигонов

- **Входные данные**:
    
    - `point_layer` — точечный слой;
        
    - `dem_layer` — растровый слой высот;
        
    - параметры масштаба ресемплинга (`RESAMPLE_SCALE`) и интервала изолиний (`CONTOUR_INTERVAL`).
        
- **Этапы**:
    
    - Добавление поля `point_id` с уникальным ID для каждой точки.
        
    - Ресемплинг DEM с использованием фильтра SAGA для сглаживания рельефа (устранение шумов, получение гладких полигонов изолиний).
        
    - Генерация полигональных изолиний с интервалом `CONTOUR_INTERVAL` (инструмент `gdal:contour_polygon`).
        
    - Разбиение мультиполигонов на отдельные полигоны.
        
    - Подсчёт количества точек, попавших в каждый полигон.
        
    - Фильтрация полигонов: удаление тех, в которых отсутствуют точки.
        

### 2. Построение иерархии полигонов

- **Логика**:
    
    - Группировка полигонов по значениям высот (`ELEV_MAX`).
        
    - Последовательное объединение полигонов для каждого уровня высот (`ELEV_MAX >= {current_elev}`).
        
    - Добавление поля `z` — уровня иерархии (1 — низший уровень).
        
    - Формирование древовидной структуры:
        
        - Поле `fid` — уникальный ID полигона;
            
        - Поле `id_child` — список ID дочерних полигонов (через запятую), то есть полигонов, полностью находящихся внутри текущего;
            
        - Поле `arr_point` — список ID точек (через запятую) внутри текущего полигона. Поскольку полигоны могут содержать другие полигоны, точки из дочерних полигонов в этот список не включаются.
            

---

## Функция `assign_clusters`

### 1. Подготовка слоя точек с назначенными кластерами

- **Входные данные**:
    
    - `data_for_clustering` — полигональный слой;
        
    - `point_layer` — точечный слой.
        
- **Этапы**:
    
    - Добавление поля `cluster` для указания принадлежности точки к кластеру.
        
    - Рекурсивное назначение номера кластера каждой точке.
        

### 2. Рекурсивное определение кластера

- **Входные данные**:
    
    - `current_poly_id` — текущий полигон;
        
    - `point_geom` — геометрия текущей точки.
        
- **Алгоритм**:
    
    1. Если у `current_poly_id` нет дочерних полигонов:
        
        - Присвоить точке номер кластера, равный `current_poly_id`.
            
    2. Если у полигона есть дочерние элементы:
        
        - При одном дочернем полигоне — продолжить поиск в нём.
            
        - При нескольких — выбрать ближайший дочерний полигон.
            
    3. Повторять до достижения полигона без дочерних элементов.
        

### 3. Обновление атрибутов точек

- Группировка полигонов по уровню высоты (`z`).
    
- Обход дерева выполняется «сверху вниз» (от высоких значений `z` к низким).
	

---

## Выходные данные

- **Слой изолиний**:
    
    - `fid` — уникальный ID полигона;
        
    - `z` — уровень в иерархии;
        
    - `id_child` — ID дочерних элементов;
        
    - `arr_point` — список точек в полигоне (без учёта дочерних).
        
- **Точечный слой**:
    
    - `cluster` — ID кластера (соответствует `fid` терминального полигона).


## Как пользоваться полученными слоями

### Points_and_clusters
 * **Узнать значение данных:**
	 
	1. Чтобы увидеть, к какому кластеру принадлежат точки, необходимо на панели слева `Слои` нажать правой кнопкой мыши на слой `Points_and_clusters`:
		  ![](Attachments/1.png)
	2. Нажать `Открыть таблицу атрибутов`. В столбце `cluster` будет указана принадлежность точки к кластеру:
		  ![](Attachments/2.png)
	- **Замечание**: Для некоторых точек кластер имеет значение `NULL`, так как эти точки лежат вне границ обрабатываемого участка.

* **Визуализация данных:**	
	1. Для визуализации распределения точек по кластерам на карте, необходимо слева на панели `Слои`нажать правой кнопкой мыши на слой `Points_and_clusters` : 
		![](Attachments/3.png)
	2. Нажать `Свойства` и в новом окне в вкладке `Стиль` изменить `Простая символика` на `Символизация по уникальным значениям`:
		![](Attachments/4.png)
		![](Attachments/5.png)
	3. В поле `Значение` выбрать `cluster`:
		![](Attachments/7.png)
	4. Нажмите `Классифицировать` и `Применить`:
		![](Attachments/8.png)
		![](Attachments/9.png)
	5. Теперь на карте видно распределение кластеров среди точек:
		![](Attachments/10.png)

### Изолинии
 * **Визуализация данных:**
	 1. Для того чтобы настроить вид слоя `Изолинии`, необходимо слева на панели `Слои`правой кнопкой мыши нажать на слой `Изолинии` :
		 ![](Attachments/12.png)
	 2. Нажать `Свойства` и в новом окне в вкладке `Стиль` изменить `Простая символика` на `Символизация по уникальным значениям`:
		 ![](Attachments/13.png)
		 ![](Attachments/15.png)
	3. Затем в поле `Значение` выбрать `z`:
		![](Attachments/16.png)
	4. Нажав на `Random colors` выбрать цветовую палитру `Turbo` или любую другую:
		![](Attachments/18.png)
	5. Нажать `Классифицировать` и `Применить`:
		![](Attachments/20.png)
		![](Attachments/21.png)
	6. Теперь на карте видно изолинии в выбранной цветовой палитре:
		![](Attachments/22.png)

* **Советы:**
	* Если хотите настроить отображение для точек определенного цвета, то просто два раза нажмите на точку в поле `Знак` рядом со значением необходимого кластера(Аналогично делается и в слое `Изолинии`):
		![](Attachments/24.png)
	* Если хотите выключить отображение какого-нибудь слоя, то просто уберите галочку слева от названия этого слоя:
		![](Attachments/25.png)
		![](Attachments/26.png)
	* Если хотите чтобы было видно `Изолини`, и над ними, к примеру, слой `water`, то зажав ЛКМ на `water` перетащите его в любую строку, которая находиться выше слоя `Изолинии`(Это работает с любыми слоями):
		![](Attachments/27.png)
		![](Attachments/28.png)
	* Если хотите увидеть другие слои `Изолинии`, то нажмите на стрелку слева от слоя `Изолинии` и выключите отображение ненужных  слоёв, убрав галочки слева от них:
		![](Attachments/30.png)
		![](Attachments/29.png)
