## Функция `preparing_data_for_clustering`

### 1. Подготовка точек и полигонов

- **Входные данные**:
    
    - `point_layer` — точечный слой;
        
    - `dem_layer` — растровый слой высот;
        
    - параметры масштаба ресемплинга (`RESAMPLE_SCALE`) и интервала изолиний (`CONTOUR_INTERVAL`).
        
- **Этапы**:
    
    - Добавление поля `point_id` с уникальным ID для каждой точки.
        
    - Ресемплинг DEM с использованием фильтра SAGA для сглаживания рельефа (устранение шумов, получение гладких полигонов изолиний).
        
    - Генерация полигональных изолиний с интервалом `CONTOUR_INTERVAL` (инструмент `gdal:contour_polygon`).
        
    - Разбиение мультиполигонов на отдельные полигоны.
        
    - Подсчёт количества точек, попавших в каждый полигон.
        
    - Фильтрация полигонов: удаление тех, в которых отсутствуют точки.
        

### 2. Построение иерархии полигонов

- **Логика**:
    
    - Группировка полигонов по значениям высот (`ELEV_MAX`).
        
    - Последовательное объединение полигонов для каждого уровня высот (`ELEV_MAX >= {current_elev}`).
        
    - Добавление поля `z` — уровня иерархии (1 — низший уровень).
        
    - Формирование древовидной структуры:
        
        - Поле `fid` — уникальный ID полигона;
            
        - Поле `id_child` — список ID дочерних полигонов (через запятую), то есть полигонов, полностью находящихся внутри текущего;
            
        - Поле `arr_point` — список ID точек (через запятую) внутри текущего полигона. Поскольку полигоны могут содержать другие полигоны, точки из дочерних полигонов в этот список не включаются.
            

---

## Функция `assign_clusters`

### 1. Подготовка слоя точек с назначенными кластерами

- **Входные данные**:
    
    - `data_for_clustering` — полигональный слой;
        
    - `point_layer` — точечный слой.
        
- **Этапы**:
    
    - Добавление поля `cluster` для указания принадлежности точки к кластеру.
        
    - Рекурсивное назначение номера кластера каждой точке.
        

### 2. Рекурсивное определение кластера

- **Входные данные**:
    
    - `current_poly_id` — текущий полигон;
        
    - `point_geom` — геометрия текущей точки.
        
- **Алгоритм**:
    
    1. Если у `current_poly_id` нет дочерних полигонов:
        
        - Присвоить точке номер кластера, равный `current_poly_id`.
            
    2. Если у полигона есть дочерние элементы:
        
        - При одном дочернем полигоне — продолжить поиск в нём.
            
        - При нескольких — выбрать ближайший дочерний полигон.
            
    3. Повторять до достижения полигона без дочерних элементов.
        

### 3. Обновление атрибутов точек

- Группировка полигонов по уровню высоты (`z`).
    
- Обход дерева выполняется «сверху вниз» (от высоких значений `z` к низким).
    

---

## Выходные данные

- **Слой изолиний**:
    
    - `fid` — уникальный ID полигона;
        
    - `z` — уровень в иерархии;
        
    - `id_child` — ID дочерних элементов;
        
    - `arr_point` — список точек в полигоне (без учёта дочерних).
        
- **Точечный слой**:
    
    - `cluster` — ID кластера (соответствует `fid` терминального полигона).